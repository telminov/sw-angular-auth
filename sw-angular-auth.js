(function() {
  angular.module('swAuth', ['ngCookies', 'ngRoute']).constant('AUTH_UPDATE_USER', 'sw_auth_service_update_user').constant('AUTH_SERVER_REJECT', 'sw_auth_service_server_401_or_403_reject').config(function($httpProvider) {
    return $httpProvider.interceptors.push('authInterceptor');
  }).factory('authInterceptor', function($location, $q, $rootScope, AUTH_SERVER_REJECT) {
    return {
      responseError: function(response) {
        if ((response != null ? response.status : void 0) === 401 || (response != null ? response.status : void 0) === 403) {
          $rootScope.$broadcast(AUTH_SERVER_REJECT, response.status, response.data);
        }
        return $q.reject(response);
      }
    };
  }).run(function($rootScope, $location, auth, AUTH_UPDATE_USER, AUTH_SERVER_REJECT) {
    $rootScope.$on('$routeChangeStart', function(scope, next, current) {
      var loginUrl, nextPath, ref;
      nextPath = '';
      if (next != null ? (ref = next.$$route) != null ? ref.originalPath : void 0 : void 0) {
        nextPath = next.$$route.originalPath;
      }
      if (!auth.isAuthenticated()) {
        loginUrl = auth.getLoginUrl();
        if (loginUrl === nextPath) {
          return;
        }
        return $location.path(loginUrl);
      }
    });
    return $rootScope.$on(AUTH_SERVER_REJECT, function(event, server_status) {
      auth.clearCurrentUser();
      return $location.path(auth.getLoginUrl());
    });
  });

}).call(this);

(function() {
  angular.module('swAuth').provider('authConfig', function() {
    var config;
    config = {
      systemLabel: 'System Label',
      serverAddress: '/server_url',
      serverLoginUrl: '/api/auth/login/',
      serverLogoutUrl: '/api/auth/logout/',
      serverUserInfoUrl: '/api/auth/current_user/',
      serverCSRFUrl: '/api/auth/get_csrf/',
      appLoginUrl: '/login/'
    };
    return {
      $get: function() {
        return {
          getSystemLabel: function() {
            return config.systemLabel;
          },
          getServerAddress: function() {
            return config.serverAddress;
          },
          getServerLoginUrl: function() {
            return config.serverAddress + config.serverLoginUrl;
          },
          getServerLogoutUrl: function() {
            return config.serverAddress + config.serverLogoutUrl;
          },
          getServerUserInfoUrl: function() {
            return config.serverAddress + config.serverUserInfoUrl;
          },
          getServerCSRFUrl: function() {
            return config.serverAddress + config.serverCSRFUrl;
          },
          getAppLoginUrl: function() {
            return config.appLoginUrl;
          }
        };
      },
      setSystemLabel: function(label) {
        return config.systemLabel = label;
      },
      setServerAddress: function(address) {
        return config.serverAddress = address;
      },
      setServerLoginUrl: function(url) {
        return config.serverLoginUrl = url;
      },
      setServerLogoutUrl: function(url) {
        return config.serverLogoutUrl = url;
      },
      setServerUserInfoUrl: function(url) {
        return config.serverUserInfoUrl = url;
      },
      setServerCSRFUrl: function(url) {
        return config.serverCSRFUrl = url;
      },
      setAppLoginUrl: function(url) {
        return config.appLoginUrl = url;
      }
    };
  });

}).call(this);

(function() {
  angular.module('swAuth').service('auth', function($http, $rootScope, $cookieStore, authConfig, AUTH_UPDATE_USER) {
    var auth;
    auth = this;
    auth.getUser = function() {
      return $cookieStore.get('user');
    };
    auth.setUser = function(newUserData) {
      var oldUserData;
      oldUserData = auth.getUser();
      $cookieStore.put('user', newUserData);
      return $rootScope.$broadcast(AUTH_UPDATE_USER, newUserData, oldUserData);
    };
    auth.isAuthenticated = function(userData) {
      var user;
      user = userData || auth.getUser();
      return (user != null ? user.is_authenticated : void 0) || false;
    };
    auth.getName = function(userData) {
      var user;
      user = userData || auth.getUser();
      return user != null ? user.username : void 0;
    };
    auth.getLoginUrl = function() {
      return authConfig.getAppLoginUrl();
    };
    auth.login = function(username, password) {
      var loginPromise, loginUrl;
      loginUrl = authConfig.getServerLoginUrl();
      loginPromise = $http({
        method: "POST",
        url: loginUrl,
        data: $.param({
          username: username,
          password: password
        }),
        withCredentials: true
      });
      loginPromise = loginPromise.then(function() {
        return auth.getCurrentUser();
      });
      return loginPromise;
    };
    auth.getCurrentUser = function() {
      var userPromise;
      userPromise = $http({
        method: "GET",
        url: authConfig.getServerUserInfoUrl(),
        withCredentials: true
      });
      userPromise = userPromise.then(function(response) {
        var newUserData;
        newUserData = response.data;
        auth.setUser(newUserData);
        return newUserData;
      });
      return userPromise;
    };
    auth.clearCurrentUser = function() {
      var newUserData;
      newUserData = {};
      return auth.setUser(newUserData);
    };
    auth.logout = function() {
      var logoutPromise;
      logoutPromise = $http({
        method: "POST",
        url: authConfig.getServerLogoutUrl(),
        withCredentials: true
      });
      logoutPromise.then(function() {
        return auth.clearCurrentUser();
      });
      return logoutPromise;
    };
  });

}).call(this);

(function() {
  angular.module('swAuth').controller('AuthLoginCtrl', function($scope, $location, auth, authConfig) {
    var fail, success;
    $scope.header = authConfig.getSystemLabel();
    success = function() {
      return $location.path('/');
    };
    fail = function(response) {
      var ref;
      return $scope.loginErrors = ((ref = response.data) != null ? ref.errors : void 0) || ['Ошибка аутентификации'];
    };
    return $scope.logIn = function() {
      var loginPromise;
      $scope.loginErrors = void 0;
      loginPromise = auth.login($scope.login, $scope.password);
      return loginPromise.then(success, fail);
    };
  });

}).call(this);

(function() {
  angular.module('swAuth').controller('AuthLogoutCtrl', function($scope, $location, $log, auth, authConfig) {
    $scope.header = authConfig.getSystemLabel();
    $scope.inProcess = true;
    return auth.logout().then(function() {
      $scope.inProcess = false;
      return $location.path('/');
    }, function(response) {
      $scope.inProcess = false;
      $log.error(response);
      return $scope.logoutError = "Ошибка выхода";
    });
  });

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5jb2ZmZWUiLCJjb25maWcuY29mZmVlIiwic2VydmljZXMuY29mZmVlIiwiY29udHJvbGxlcnMvbG9naW4uY29mZmVlIiwiY29udHJvbGxlcnMvbG9nb3V0LmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLEVBQUEsT0FBTyxDQUFDLE1BQVIsQ0FBZSxRQUFmLEVBQXlCLENBQ3JCLFdBRHFCLEVBRXJCLFNBRnFCLENBQXpCLENBS0ksQ0FBQyxRQUxMLENBS2Msa0JBTGQsRUFLa0MsNkJBTGxDLENBTUksQ0FBQyxRQU5MLENBTWMsb0JBTmQsRUFNb0MsMENBTnBDLENBUUksQ0FBQyxNQVJMLENBUVksU0FBQyxhQUFELEdBQUE7V0FDSixhQUFhLENBQUMsWUFBWSxDQUFDLElBQTNCLENBQWdDLGlCQUFoQyxFQURJO0VBQUEsQ0FSWixDQVlJLENBQUMsT0FaTCxDQVlhLGlCQVpiLEVBWWdDLFNBQUMsU0FBRCxFQUFZLEVBQVosRUFBZ0IsVUFBaEIsRUFBNEIsa0JBQTVCLEdBQUE7QUFDeEIsV0FBTztBQUFBLE1BQ0gsYUFBQSxFQUFlLFNBQUMsUUFBRCxHQUFBO0FBQ1gsUUFBQSx3QkFBRyxRQUFRLENBQUUsZ0JBQVYsS0FBb0IsR0FBcEIsd0JBQTJCLFFBQVEsQ0FBRSxnQkFBVixLQUFvQixHQUFsRDtBQUNJLFVBQUEsVUFBVSxDQUFDLFVBQVgsQ0FBc0Isa0JBQXRCLEVBQTBDLFFBQVEsQ0FBQyxNQUFuRCxFQUEyRCxRQUFRLENBQUMsSUFBcEUsQ0FBQSxDQURKO1NBQUE7QUFFQSxlQUFPLEVBQUUsQ0FBQyxNQUFILENBQVUsUUFBVixDQUFQLENBSFc7TUFBQSxDQURaO0tBQVAsQ0FEd0I7RUFBQSxDQVpoQyxDQXNCSSxDQUFDLEdBdEJMLENBc0JTLFNBQUMsVUFBRCxFQUFhLFNBQWIsRUFBd0IsSUFBeEIsRUFBOEIsZ0JBQTlCLEVBQWdELGtCQUFoRCxHQUFBO0FBRUQsSUFBQSxVQUFVLENBQUMsR0FBWCxDQUFlLG1CQUFm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QUFtQixJQUZuQixDQUFBO1dBR0EsSUFBSSxDQUFDLE1BQUwsQ0FBQSxDQUFhLENBQUMsSUFBZCxDQUNJLFNBQUEsR0FBQTtBQUNJLE1BQUEsTUFBTSxDQUFDLFNBQVAsR0FBbUIsS0FBbkIsQ0FBQTthQUNBLFNBQVMsQ0FBQyxJQUFWLENBQWUsR0FBZixFQUZKO0lBQUEsQ0FESixFQUlJLFNBQUMsUUFBRCxHQUFBO0FBQ0ksTUFBQSxNQUFNLENBQUMsU0FBUCxHQUFtQixLQUFuQixDQUFBO0FBQUEsTUFDQSxJQUFJLENBQUMsS0FBTCxDQUFXLFFBQVgsQ0FEQSxDQUFBO2FBRUEsTUFBTSxDQUFDLFdBQVAsR0FBcUIsZ0JBSHpCO0lBQUEsQ0FKSixFQUowQjtFQUFBLENBRGxDLENBQUEsQ0FBQTtBQUFBIiwiZmlsZSI6InN3LWFuZ3VsYXItYXV0aC5qcyIsInNvdXJjZXNDb250ZW50IjpbImFuZ3VsYXIubW9kdWxlKCdzd0F1dGgnLCBbXG4gICAgJ25nQ29va2llcydcbiAgICAnbmdSb3V0ZSdcbl0pXG5cbiAgICAuY29uc3RhbnQoJ0FVVEhfVVBEQVRFX1VTRVInLCAnc3dfYXV0aF9zZXJ2aWNlX3VwZGF0ZV91c2VyJylcbiAgICAuY29uc3RhbnQoJ0FVVEhfU0VSVkVSX1JFSkVDVCcsICdzd19hdXRoX3NlcnZpY2Vfc2VydmVyXzQwMV9vcl80MDNfcmVqZWN0JylcblxuICAgIC5jb25maWcgKCRodHRwUHJvdmlkZXIpIC0+XG4gICAgICAgICRodHRwUHJvdmlkZXIuaW50ZXJjZXB0b3JzLnB1c2goJ2F1dGhJbnRlcmNlcHRvcicpXG5cbiAgICAjIGJyb2FkY2FzdCBvZiA0MDEgb3IgNDAzIGh0dHAgc3RhdHVzXG4gICAgLmZhY3RvcnkgJ2F1dGhJbnRlcmNlcHRvcicsICgkbG9jYXRpb24sICRxLCAkcm9vdFNjb3BlLCBBVVRIX1NFUlZFUl9SRUpFQ1QpIC0+XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICByZXNwb25zZUVycm9yOiAocmVzcG9uc2UpIC0+XG4gICAgICAgICAgICAgICAgaWYgcmVzcG9uc2U/LnN0YXR1cyA9PSA0MDEgb3IgcmVzcG9uc2U/LnN0YXR1cyA9PSA0MDNcbiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0IEFVVEhfU0VSVkVSX1JFSkVDVCwgcmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5kYXRhXG4gICAgICAgICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZXNwb25zZSlcblxuICAgICAgICB9XG5cblxuICAgIC5ydW4gKCRyb290U2NvcGUsICRsb2NhdGlvbiwgYXV0aCwgQVVUSF9VUERBVEVfVVNFUiwgQVVUSF9TRVJWRVJfUkVKRUNUKSAtPlxuICAgICAgICAjIHN1YnNjcmliZSBvbiB1cmwgY2hhbmdpbmdcbiAgICAgICAgJHJvb3RTY29wZS4kb24gJyRyb3V0ZUNoYW5nZVN0YXJ0JywgKHNjb3BlLCBuZXh0LCBjdXJyZW50KSAtPlxuICAgICAgICAgICAgIyBzYXZlIG9yaWdpbiBwYXRoXG4gICAgICAgICAgICBuZXh0UGF0aCA9ICcnXG4gICAgICAgICAgICBpZiBuZXh0Py4kJHJvdXRlPy5vcmlnaW5hbFBhdGhcbiAgICAgICAgICAgICAgICBuZXh0UGF0aCA9IG5leHQuJCRyb3V0ZS5vcmlnaW5hbFBhdGhcblxuICAgICAgICAgICAgIyByZWRpcmVjdCBub3QgYXV0aG9yaXplZCB1c2VyIHRvIGxvZ2luIHBhZ2VcbiAgICAgICAgICAgIGlmIG5vdCBhdXRoLmlzQXV0aGVudGljYXRlZCgpXG4gICAgICAgICAgICAgICAgbG9naW5VcmwgPSBhdXRoLmdldExvZ2luVXJsKClcblxuICAgICAgICAgICAgICAgICMgc2tpcCByZWRpcmVjdGlvbiBpZiB3ZSBhcmUgZ29pbmcgdG8gbG9naW4gcGFnZVxuICAgICAgICAgICAgICAgIGlmIGxvZ2luVXJsID09IG5leHRQYXRoXG4gICAgICAgICAgICAgICAgICAgIHJldHVyblxuXG4gICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgobG9naW5VcmwpXG5cbiAgICAgICAgIyBzdWJzY3JpYmUgc2VydmVyIHJlamVjdGluZ1xuICAgICAgICAkcm9vdFNjb3BlLiRvbiBBVVRIX1NFUlZFUl9SRUpFQ1QsIChldmVudCwgc2VydmVyX3N0YXR1cykgLT5cbiAgICAgICAgICAgIGF1dGguY2xlYXJDdXJyZW50VXNlcigpXG4gICAgICAgICAgICAkbG9jYXRpb24ucGF0aChhdXRoLmdldExvZ2luVXJsKCkpIiwiYW5ndWxhci5tb2R1bGUoJ3N3QXV0aCcpXHJcbiAgICAucHJvdmlkZXIgJ2F1dGhDb25maWcnLCAtPlxyXG4gICAgICAgIGNvbmZpZyA9IHtcclxuICAgICAgICAgICAgc3lzdGVtTGFiZWw6ICdTeXN0ZW0gTGFiZWwnXHJcbiAgICAgICAgICAgIHNlcnZlckFkZHJlc3M6ICcvc2VydmVyX3VybCdcclxuICAgICAgICAgICAgc2VydmVyTG9naW5Vcmw6ICcvYXBpL2F1dGgvbG9naW4vJ1xyXG4gICAgICAgICAgICBzZXJ2ZXJMb2dvdXRVcmw6ICcvYXBpL2F1dGgvbG9nb3V0LydcclxuICAgICAgICAgICAgc2VydmVyVXNlckluZm9Vcmw6ICcvYXBpL2F1dGgvY3VycmVudF91c2VyLydcclxuICAgICAgICAgICAgc2VydmVyQ1NSRlVybDogJy9hcGkvYXV0aC9nZXRfY3NyZi8nXHJcbiAgICAgICAgICAgIGFwcExvZ2luVXJsOiAnL2xvZ2luLydcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICRnZXQ6IC0+XHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgZ2V0U3lzdGVtTGFiZWw6IC0+IGNvbmZpZy5zeXN0ZW1MYWJlbFxyXG4gICAgICAgICAgICAgICAgICAgIGdldFNlcnZlckFkZHJlc3M6IC0+IGNvbmZpZy5zZXJ2ZXJBZGRyZXNzXHJcbiAgICAgICAgICAgICAgICAgICAgZ2V0U2VydmVyTG9naW5Vcmw6IC0+IGNvbmZpZy5zZXJ2ZXJBZGRyZXNzICsgY29uZmlnLnNlcnZlckxvZ2luVXJsXHJcbiAgICAgICAgICAgICAgICAgICAgZ2V0U2VydmVyTG9nb3V0VXJsOiAtPiBjb25maWcuc2VydmVyQWRkcmVzcyArIGNvbmZpZy5zZXJ2ZXJMb2dvdXRVcmxcclxuICAgICAgICAgICAgICAgICAgICBnZXRTZXJ2ZXJVc2VySW5mb1VybDogLT4gY29uZmlnLnNlcnZlckFkZHJlc3MgKyBjb25maWcuc2VydmVyVXNlckluZm9VcmxcclxuICAgICAgICAgICAgICAgICAgICBnZXRTZXJ2ZXJDU1JGVXJsOiAtPiBjb25maWcuc2VydmVyQWRkcmVzcyArIGNvbmZpZy5zZXJ2ZXJDU1JGVXJsXHJcbiAgICAgICAgICAgICAgICAgICAgZ2V0QXBwTG9naW5Vcmw6IC0+IGNvbmZpZy5hcHBMb2dpblVybFxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgc2V0U3lzdGVtTGFiZWw6IChsYWJlbCkgLT5cclxuICAgICAgICAgICAgICAgIGNvbmZpZy5zeXN0ZW1MYWJlbCA9IGxhYmVsXHJcblxyXG4gICAgICAgICAgICBzZXRTZXJ2ZXJBZGRyZXNzOiAoYWRkcmVzcykgLT5cclxuICAgICAgICAgICAgICAgIGNvbmZpZy5zZXJ2ZXJBZGRyZXNzID0gYWRkcmVzc1xyXG5cclxuICAgICAgICAgICAgc2V0U2VydmVyTG9naW5Vcmw6ICh1cmwpIC0+XHJcbiAgICAgICAgICAgICAgICBjb25maWcuc2VydmVyTG9naW5VcmwgPSB1cmxcclxuXHJcbiAgICAgICAgICAgIHNldFNlcnZlckxvZ291dFVybDogKHVybCkgLT5cclxuICAgICAgICAgICAgICAgIGNvbmZpZy5zZXJ2ZXJMb2dvdXRVcmwgPSB1cmxcclxuXHJcbiAgICAgICAgICAgIHNldFNlcnZlclVzZXJJbmZvVXJsOiAodXJsKSAtPlxyXG4gICAgICAgICAgICAgICAgY29uZmlnLnNlcnZlclVzZXJJbmZvVXJsID0gdXJsXHJcblxyXG4gICAgICAgICAgICBzZXRTZXJ2ZXJDU1JGVXJsOiAodXJsKSAtPlxyXG4gICAgICAgICAgICAgICAgY29uZmlnLnNlcnZlckNTUkZVcmwgPSB1cmxcclxuXHJcbiAgICAgICAgICAgIHNldEFwcExvZ2luVXJsOiAodXJsKSAtPlxyXG4gICAgICAgICAgICAgICAgY29uZmlnLmFwcExvZ2luVXJsID0gdXJsXHJcbiAgICAgICAgfSIsImFuZ3VsYXIubW9kdWxlKCdzd0F1dGgnKVxuICAgIC5zZXJ2aWNlICdhdXRoJywgKCRodHRwLCAkcm9vdFNjb3BlLCAkY29va2llU3RvcmUsIGF1dGhDb25maWcsIEFVVEhfVVBEQVRFX1VTRVIpIC0+XG4gICAgICAgIGF1dGggPSB0aGlzXG5cbiAgICAgICAgYXV0aC5nZXRVc2VyID0gLT5cbiAgICAgICAgICAgIHJldHVybiAkY29va2llU3RvcmUuZ2V0KCd1c2VyJylcblxuICAgICAgICBhdXRoLnNldFVzZXIgPSAobmV3VXNlckRhdGEpIC0+XG4gICAgICAgICAgICBvbGRVc2VyRGF0YSA9IGF1dGguZ2V0VXNlcigpXG4gICAgICAgICAgICAkY29va2llU3RvcmUucHV0KCd1c2VyJywgbmV3VXNlckRhdGEpXG4gICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QgQVVUSF9VUERBVEVfVVNFUiwgbmV3VXNlckRhdGEsIG9sZFVzZXJEYXRhXG5cbiAgICAgICAgYXV0aC5pc0F1dGhlbnRpY2F0ZWQgPSAodXNlckRhdGEpLT5cbiAgICAgICAgICAgIHVzZXIgPSB1c2VyRGF0YSBvciBhdXRoLmdldFVzZXIoKVxuICAgICAgICAgICAgcmV0dXJuIHVzZXI/LmlzX2F1dGhlbnRpY2F0ZWQgb3IgZmFsc2VcblxuICAgICAgICBhdXRoLmdldE5hbWUgPSAodXNlckRhdGEpIC0+XG4gICAgICAgICAgICB1c2VyID0gdXNlckRhdGEgb3IgYXV0aC5nZXRVc2VyKClcbiAgICAgICAgICAgIHJldHVybiB1c2VyPy51c2VybmFtZVxuXG4gICAgICAgIGF1dGguZ2V0TG9naW5VcmwgPSAtPlxuICAgICAgICAgICAgcmV0dXJuIGF1dGhDb25maWcuZ2V0QXBwTG9naW5VcmwoKVxuXG5cbiAgICAgICAgYXV0aC5sb2dpbiA9ICh1c2VybmFtZSwgcGFzc3dvcmQpIC0+XG4gICAgICAgICAgICBsb2dpblVybCA9IGF1dGhDb25maWcuZ2V0U2VydmVyTG9naW5VcmwoKVxuXG4gICAgICAgICAgICBsb2dpblByb21pc2UgPSAkaHR0cChcbiAgICAgICAgICAgICAgICBtZXRob2Q6IFwiUE9TVFwiXG4gICAgICAgICAgICAgICAgdXJsOiBsb2dpblVybFxuICAgICAgICAgICAgICAgIGRhdGE6ICQucGFyYW0oe1xuICAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogdXNlcm5hbWVcbiAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHBhc3N3b3JkXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB3aXRoQ3JlZGVudGlhbHM6IHRydWVcbiAgICAgICAgICAgIClcblxuICAgICAgICAgICAgIyBhZnRlciBsb2dpbiBnbyB0byB1c2VyIGluZm8gbWV0aG9kXG4gICAgICAgICAgICBsb2dpblByb21pc2UgPSBsb2dpblByb21pc2UudGhlbiAtPlxuICAgICAgICAgICAgICAgIHJldHVybiBhdXRoLmdldEN1cnJlbnRVc2VyKClcblxuICAgICAgICAgICAgcmV0dXJuIGxvZ2luUHJvbWlzZVxuXG5cbiAgICAgICAgYXV0aC5nZXRDdXJyZW50VXNlciA9IC0+XG4gICAgICAgICAgICB1c2VyUHJvbWlzZSA9ICRodHRwKFxuICAgICAgICAgICAgICAgIG1ldGhvZDogXCJHRVRcIlxuICAgICAgICAgICAgICAgIHVybDogYXV0aENvbmZpZy5nZXRTZXJ2ZXJVc2VySW5mb1VybCgpXG4gICAgICAgICAgICAgICAgd2l0aENyZWRlbnRpYWxzOiB0cnVlXG4gICAgICAgICAgICApXG5cbiAgICAgICAgICAgICMgYWRkIHNhdmUgdXNlciBpbmZvIG1ldGhvZCBjYWxsXG4gICAgICAgICAgICB1c2VyUHJvbWlzZSA9IHVzZXJQcm9taXNlLnRoZW4gKHJlc3BvbnNlKSAtPlxuICAgICAgICAgICAgICAgIG5ld1VzZXJEYXRhID0gcmVzcG9uc2UuZGF0YVxuICAgICAgICAgICAgICAgIGF1dGguc2V0VXNlcihuZXdVc2VyRGF0YSlcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3VXNlckRhdGFcblxuICAgICAgICAgICAgcmV0dXJuIHVzZXJQcm9taXNlXG5cblxuICAgICAgICBhdXRoLmNsZWFyQ3VycmVudFVzZXIgPSAtPlxuICAgICAgICAgICAgbmV3VXNlckRhdGEgPSB7fVxuICAgICAgICAgICAgYXV0aC5zZXRVc2VyKG5ld1VzZXJEYXRhKVxuXG4gICAgICAgIGF1dGgubG9nb3V0ID0gLT5cbiAgICAgICAgICAgIGxvZ291dFByb21pc2UgPSAkaHR0cChcbiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBcIlBPU1RcIlxuICAgICAgICAgICAgICAgICAgICB1cmw6IGF1dGhDb25maWcuZ2V0U2VydmVyTG9nb3V0VXJsKClcbiAgICAgICAgICAgICAgICAgICAgd2l0aENyZWRlbnRpYWxzOiB0cnVlXG4gICAgICAgICAgICAgICAgKVxuXG4gICAgICAgICAgICBsb2dvdXRQcm9taXNlLnRoZW4gLT5cbiAgICAgICAgICAgICAgICBhdXRoLmNsZWFyQ3VycmVudFVzZXIoKVxuXG4gICAgICAgICAgICByZXR1cm4gbG9nb3V0UHJvbWlzZVxuXG4gICAgICAgIHJldHVybiIsImFuZ3VsYXIubW9kdWxlKCdzd0F1dGgnKVxuICAgIC5jb250cm9sbGVyICdBdXRoTG9naW5DdHJsJywgKCRzY29wZSwgJGxvY2F0aW9uLCBhdXRoLCBhdXRoQ29uZmlnKSAtPlxuICAgICAgICAkc2NvcGUuaGVhZGVyID0gYXV0aENvbmZpZy5nZXRTeXN0ZW1MYWJlbCgpXG5cbiAgICAgICAgc3VjY2VzcyA9IC0+XG4gICAgICAgICAgICAkbG9jYXRpb24ucGF0aCgnLycpXG5cbiAgICAgICAgZmFpbCA9IChyZXNwb25zZSkgLT5cbiAgICAgICAgICAgICRzY29wZS5sb2dpbkVycm9ycyA9IHJlc3BvbnNlLmRhdGE/LmVycm9ycyBvciBbJ9Ce0YjQuNCx0LrQsCDQsNGD0YLQtdC90YLQuNGE0LjQutCw0YbQuNC4J11cblxuICAgICAgICAkc2NvcGUubG9nSW4gPSAtPlxuICAgICAgICAgICAgJHNjb3BlLmxvZ2luRXJyb3JzID0gdW5kZWZpbmVkXG5cbiAgICAgICAgICAgIGxvZ2luUHJvbWlzZSA9IGF1dGgubG9naW4oXG4gICAgICAgICAgICAgICAgJHNjb3BlLmxvZ2luLFxuICAgICAgICAgICAgICAgICRzY29wZS5wYXNzd29yZCxcbiAgICAgICAgICAgIClcblxuICAgICAgICAgICAgbG9naW5Qcm9taXNlLnRoZW4gc3VjY2VzcywgZmFpbCIsImFuZ3VsYXIubW9kdWxlKCdzd0F1dGgnKVxuICAgIC5jb250cm9sbGVyICdBdXRoTG9nb3V0Q3RybCcsICgkc2NvcGUsICRsb2NhdGlvbiwgJGxvZywgYXV0aCwgYXV0aENvbmZpZykgLT5cbiAgICAgICAgJHNjb3BlLmhlYWRlciA9IGF1dGhDb25maWcuZ2V0U3lzdGVtTGFiZWwoKVxuXG4gICAgICAgICRzY29wZS5pblByb2Nlc3MgPSB0cnVlXG4gICAgICAgIGF1dGgubG9nb3V0KCkudGhlbihcbiAgICAgICAgICAgIC0+XG4gICAgICAgICAgICAgICAgJHNjb3BlLmluUHJvY2VzcyA9IGZhbHNlXG4gICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgoJy8nKVxuICAgICAgICAgICAgKHJlc3BvbnNlKSAtPlxuICAgICAgICAgICAgICAgICRzY29wZS5pblByb2Nlc3MgPSBmYWxzZVxuICAgICAgICAgICAgICAgICRsb2cuZXJyb3IocmVzcG9uc2UpXG4gICAgICAgICAgICAgICAgJHNjb3BlLmxvZ291dEVycm9yID0gXCLQntGI0LjQsdC60LAg0LLRi9GF0L7QtNCwXCJcbiAgICAgICAgKVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9